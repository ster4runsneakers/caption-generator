<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Social Media Assistant v3.1</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>
</head>
<body>

  <!-- Auth links -->
  <div class="user-auth">
    {% if current_user.is_authenticated %}
      <span>ğŸ‘‹ Î“ÎµÎ¹Î± ÏƒÎ¿Ï…, {{ current_user.username }}!</span>
      <a href="{{ url_for('logout') }}">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</a>
    {% else %}
      <a href="{{ url_for('login') }}">Î£ÏÎ½Î´ÎµÏƒÎ·</a>
      <a href="{{ url_for('register') }}">Î•Î³Î³ÏÎ±Ï†Î®</a>
    {% endif %}
  </div>

  <div class="container">
    <button id="theme-switch" class="theme-switch" title="Î•Î½Î±Î»Î»Î±Î³Î® dark mode" aria-pressed="false" type="button">ğŸŒ™</button>
    <h1>AI Social Media Assistant v3.1</h1>

    <!-- Tabs -->
    <div class="app-tabs" role="tablist" aria-label="ÎšÏÏÎ¹ÎµÏ‚ Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚">
      <button id="tab-text" class="active" role="tab" aria-selected="true" type="button">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎšÎµÎ¹Î¼Î­Î½Î¿Ï…</button>
      <button id="tab-image" role="tab" aria-selected="false" type="button">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î•Î¹ÎºÏŒÎ½Î±Ï‚</button>
      <button id="tab-calendar" role="tab" aria-selected="false" type="button">Î—Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿</button>
      <button id="tab-history" role="tab" aria-selected="false" type="button">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ</button>
      <button id="tab-settings" role="tab" aria-selected="false" type="button">Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚</button>
    </div>

    <div class="view-content">
      <!-- TEXT -->
      <section id="view-text" class="view-container active" role="tabpanel" aria-labelledby="tab-text">
        <p>Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ Hooks, CTAs ÎºÎ±Î¹ Captions Î³Î¹Î± Ï„Î± social media ÏƒÎ¿Ï….</p>
        <div class="form-controls">
          <input type="text" id="topic-input" placeholder="ÎšÏÏÎ¹Î¿ Î¸Î­Î¼Î±..." autocomplete="off"/>
          <input type="text" id="keywords" placeholder="Î›Î­Î¾ÎµÎ¹Ï‚-ÎºÎ»ÎµÎ¹Î´Î¹Î¬..." autocomplete="off"/>
          <select id="platform-select">
            <option value="Instagram">Instagram</option>
            <option value="TikTok">TikTok</option>
            <option value="Facebook">Facebook</option>
            <option value="Pinterest">Pinterest</option>
            <option value="YouTube">YouTube</option>
          </select>
          <select id="content-type-select">
            <option value="Caption">Full Caption</option>
            <option value="Hook">ÎœÏŒÎ½Î¿ Hook</option>
            <option value="CTA">ÎœÏŒÎ½Î¿ CTA</option>
            <option value="Hashtags">ÎœÏŒÎ½Î¿ Hashtags</option>
          </select>
          <select id="tone-select">
            <option value="Friendly">Î¦Î¹Î»Î¹ÎºÏŒ</option>
            <option value="Professional">Î•Ï€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÏŒ</option>
            <option value="Funny">Î‘ÏƒÏ„ÎµÎ¯Î¿</option>
            <option value="Enthusiastic">Î•Î½Î¸Î¿Ï…ÏƒÎ¹ÏÎ´ÎµÏ‚</option>
          </select>
          <select id="language-select">
            <option value="Greek">Î•Î»Î»Î·Î½Î¹ÎºÎ¬</option>
            <option value="English">Î‘Î³Î³Î»Î¹ÎºÎ¬</option>
          </select>
          <select id="model-select" title="Choose your AI engine">
            <option value="openai">OpenAI (GPT-4o mini)</option>
            <option value="gemini">Google (Gemini)</option>
          </select>
        </div>
        <button id="generate-text-btn" type="button">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎšÎµÎ¹Î¼Î­Î½Î¿Ï…</button>
      </section>

      <!-- IMAGE -->
      <section id="view-image" class="view-container" role="tabpanel" aria-labelledby="tab-image">
        <div class="form-section">
          <h3>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î¼Îµ AI</h3>
          <p>Î ÎµÏÎ¹Î­Î³ÏÎ±ÏˆÎµ Ï„Î·Î½ ÎµÎ¹ÎºÏŒÎ½Î± Ï€Î¿Ï… Î¸Î­Î»ÎµÎ¹Ï‚ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÎ¹ Ï„Î¿ AI.</p>
          <div class="form-controls">
            <input type="text" id="image-prompt-input" placeholder="Ï€.Ï‡., ÎˆÎ½Î±Ï‚ Î±ÏƒÏ„ÏÎ¿Î½Î±ÏÏ„Î·Ï‚ ÏƒÎµ Î¼Î¹Î± Ï€Î±ÏÎ±Î»Î¯Î±, ÏÎµÎ±Î»Î¹ÏƒÏ„Î¹ÎºÏŒ ÏƒÏ„Ï…Î»..." autocomplete="off"/>
            <select id="image-style-select">
              <option value="photorealistic">Î¦Ï‰Ï„Î¿ÏÎµÎ±Î»Î¹ÏƒÏ„Î¹ÎºÏŒ</option>
              <option value="digital art">Digital Art</option>
              <option value="cartoon">Cartoon</option>
              <option value="fantasy">Fantasy</option>
              <option value="3d render">3D Render</option>
            </select>
          </div>
          <button id="generate-image-btn" type="button">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î•Î¹ÎºÏŒÎ½Î±Ï‚ Î¼Îµ AI</button>
        </div>
        <div class="form-section">
          <h3>Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î”Î¹ÎºÎ®Ï‚ ÏƒÎ¿Ï… Î•Î¹ÎºÏŒÎ½Î±Ï‚</h3>
          <div class="upload-section">
            <input type="file" id="file-input" accept="image/png, image/jpeg"/>
            <label for="file-input" class="file-label">Î•Ï€Î¯Î»ÎµÎ¾Îµ Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±</label>
            <button id="upload-btn" type="button">Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚</button>
          </div>
        </div>
      </section>

      <!-- CALENDAR -->
      <section id="view-calendar" class="view-container" role="tabpanel" aria-labelledby="tab-calendar">
        <p>ÎŸÏÎ³Î¬Î½Ï‰ÏƒÎµ Ï„Î± Î±Î³Î±Ï€Î·Î¼Î­Î½Î± ÏƒÎ¿Ï… posts. ÎšÎ¬Î½Îµ drag & drop Î­Î½Î± caption Î±Ï€ÏŒ Ï„Î· Î»Î¯ÏƒÏ„Î± ÏƒÎµ Î¼Î¹Î± Î¼Î­ÏÎ± Ï„Î¿Ï… Î·Î¼ÎµÏÎ¿Î»Î¿Î³Î¯Î¿Ï….</p>
        <div id="calendar-container">
          <aside id="calendar-sidebar" aria-label="Î‘Î³Î±Ï€Î·Î¼Î­Î½Î±">
            <h4>â­ Î‘Î³Î±Ï€Î·Î¼Î­Î½Î±</h4>
            <div id="favorites-list"></div>
          </aside>
          <div id="calendar-main">
            <div class="calendar-grid" id="calendar-grid" aria-label="Î Î¯Î½Î±ÎºÎ±Ï‚ Î—Î¼ÎµÏÎ¿Î»Î¿Î³Î¯Î¿Ï…"></div>
          </div>
        </div>
      </section>

      <!-- HISTORY -->
      <section id="view-history" class="view-container" role="tabpanel" aria-labelledby="tab-history">
        <div class="history-controls">
          <div class="tabs" role="tablist">
            <button id="subtab-history" class="active" role="tab" aria-selected="true" type="button">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ</button>
            <button id="subtab-favorites" role="tab" aria-selected="false" type="button">Î‘Î³Î±Ï€Î·Î¼Î­Î½Î±</button>
          </div>
          <input type="text" id="search-history" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..." autocomplete="off" aria-label="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÏƒÏ„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ"/>
        </div>
        <div id="history-results-container" aria-live="polite"></div>
      </section>

      <!-- SETTINGS -->
      <section id="view-settings" class="view-container" role="tabpanel" aria-labelledby="tab-settings">
        <h3>Î— Î¦Ï‰Î½Î® Ï„Î¿Ï… Brand ÏƒÎ¿Ï… (Brand Voice)</h3>
        <p>Î ÎµÏÎ¹Î­Î³ÏÎ±ÏˆÎµ Ï„Î¿ ÏÏ†Î¿Ï‚ ÎºÎ±Î¹ Ï„Î·Î½ Ï€ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÏŒÏ„Î·Ï„Î± Ï„Î¿Ï… brand ÏƒÎ¿Ï…. Î¤Î¿ AI Î¸Î± Î±ÎºÎ¿Î»Î¿Ï…Î¸ÎµÎ¯ Ï€Î¬Î½Ï„Î± Î±Ï…Ï„Î­Ï‚ Ï„Î¹Ï‚ Î¿Î´Î·Î³Î¯ÎµÏ‚.</p>
        <textarea id="brand-voice-input" rows="6" placeholder="Ï€.Ï‡., Î•Î¯Î¼Î±ÏƒÏ„Îµ Î­Î½Î± Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¬ÏÎ¹ÎºÎ¿ brand. Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Î±Ï€Î»Î® Î³Î»ÏÏƒÏƒÎ±, Ï€Î¿Î»Î»Î¬ emojis ÎºÎ±Î¹ Ï€Î¬Î½Ï„Î± Ï‡Î¹Î¿ÏÎ¼Î¿Ï..."></textarea>
        <button id="save-settings-btn" type="button">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î¡Ï…Î¸Î¼Î¯ÏƒÎµÏ‰Î½</button>
      </section>
    </div>

    <!-- Spinner & Results -->
    <div id="spinner-container" class="spinner-container" aria-hidden="true" style="display:none;">
      <div class="spinner" role="status" aria-label="Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ"></div>
    </div>
    <div id="generation-results" aria-live="polite"></div>
  </div>

  <!-- JavaScript -->
  <script>
    // --- Elements ---
    const themeSwitch = document.getElementById('theme-switch');
    const textTab = document.getElementById('tab-text');
    const imageTab = document.getElementById('tab-image');
    const calendarTab = document.getElementById('tab-calendar');
    const historyTab = document.getElementById('tab-history');
    const settingsTab = document.getElementById('tab-settings');

    const textView = document.getElementById('view-text');
    const imageView = document.getElementById('view-image');
    const calendarView = document.getElementById('view-calendar');
    const historyView = document.getElementById('view-history');
    const settingsView = document.getElementById('view-settings');

    const generateTextBtn = document.getElementById('generate-text-btn');
    const generateImageBtn = document.getElementById('generate-image-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const fileInput = document.getElementById('file-input');

    const spinnerContainer = document.getElementById('spinner-container');
    const generationResultsContainer = document.getElementById('generation-results');

    const historySubTab = document.getElementById('subtab-history');
    const favoritesSubTab = document.getElementById('subtab-favorites');
    const searchInput = document.getElementById('search-history');
    const brandVoiceInput = document.getElementById('brand-voice-input');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const favoritesList = document.getElementById('favorites-list');
    const calendarGrid = document.getElementById('calendar-grid');

    let currentHistoryView = 'history';

    // Storage helpers
    function getStorage(key) {
      try { return JSON.parse(localStorage.getItem(key) || '[]'); }
      catch { return []; }
    }
    function setStorage(key, value) { localStorage.setItem(key, JSON.stringify(value)); }
    function saveToHistory(items) {
      const history = getStorage('history');
      const updated = [...items, ...history].slice(0, 50);
      setStorage('history', updated);
    }

    // UI helpers
    function createResultCard(text, isFavorite, container) {
      const card = document.createElement('div');
      card.className = 'result-card';
      const p = document.createElement('p');
      p.textContent = text;
      const btns = document.createElement('div');
      btns.className = 'card-buttons';

      const copy = document.createElement('button');
      copy.type = 'button';
      copy.textContent = 'ğŸ“‹ Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î®';
      copy.addEventListener('click', () => {
        navigator.clipboard.writeText(text);
        copy.textContent = 'âœ… Î‘Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ!';
        setTimeout(() => copy.textContent = 'ğŸ“‹ Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î®', 1500);
      });

      const fav = document.createElement('button');
      fav.type = 'button';
      fav.textContent = isFavorite ? 'â˜… Î‘Î³Î±Ï€Î·Î¼Î­Î½Î¿' : 'â˜† Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·';
      fav.addEventListener('click', () => toggleFavorite(text));

      btns.appendChild(copy);
      btns.appendChild(fav);
      card.appendChild(p);
      card.appendChild(btns);

      card.draggable = true;
      card.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', text));

      container.appendChild(card);
    }

    function renderHistory(q = '') {
      const container = document.getElementById('history-results-container');
      container.innerHTML = '';
      const data = getStorage(currentHistoryView);
      const favorites = getStorage('favorites');
      data.filter(t => t.toLowerCase().includes(q.toLowerCase()))
          .forEach(t => createResultCard(t, favorites.includes(t), container));
    }

    function toggleFavorite(text) {
      let favorites = getStorage('favorites');
      if (favorites.includes(text)) favorites = favorites.filter(i => i !== text);
      else favorites = [text, ...favorites].slice(0, 50);
      setStorage('favorites', favorites);
      renderHistory(searchInput.value);
    }

    function switchTab(activeTab, activeView) {
      [textTab, imageTab, calendarTab, historyTab, settingsTab].forEach(t => {
        t.classList.remove('active'); t.setAttribute('aria-selected','false');
      });
      [textView, imageView, calendarView, historyView, settingsView].forEach(v => v.classList.remove('active'));
      activeTab.classList.add('active'); activeTab.setAttribute('aria-selected','true');
      activeView.classList.add('active');
      generationResultsContainer.innerHTML = '';
      if (activeTab === historyTab) renderHistory(searchInput.value);
      if (activeTab === calendarTab) { populateFavoritesSidebar(); renderCalendar(); }
    }

    // Networking
    function handleResponseAuth(res) {
      if (res.redirected || res.url.includes('/login')) { window.location.href = '/login'; return null; }
      const ctype = res.headers.get('content-type') || '';
      if (!ctype.includes('application/json')) { window.location.href = '/login'; return null; }
      if (res.status === 401 || res.status === 403) { window.location.href = '/login'; return null; }
      return res.json();
    }

    function splitNumberedList(text) {
      const a = text.trim().split(/\n(?=\d+\.\s)/).map(t => t.replace(/^\d+\.\s*/, '').trim()).filter(Boolean);
      if (a.length > 1) return a;
      return text.split(/\n{2,}/).map(t => t.trim()).filter(Boolean);
    }

    function setBusy(b) {
      spinnerContainer.style.display = b ? 'flex' : 'none';
      spinnerContainer.setAttribute('aria-hidden', b ? 'false' : 'true');
      [generateTextBtn, generateImageBtn, uploadBtn].forEach(x => { if (x) x.disabled = b; });
    }

    function renderImage(url, alt = 'Generated Image') {
      const card = document.createElement('div'); card.id = 'image-result-card';
      const img = document.createElement('img'); img.src = url; img.alt = alt;
      card.appendChild(img);
      generationResultsContainer.appendChild(card);
    }

    function performFetch(endpoint, payload, isImage=false) {
      setBusy(true);
      generationResultsContainer.innerHTML = '';
      fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(payload)
      })
      .then(handleResponseAuth)
      .then(data => {
        if (!data) return;
        setBusy(false);
        if (isImage) {
          if (data.image_url) renderImage(data.image_url);
          else generationResultsContainer.innerHTML = `<div class="result-card">${data.error || 'Error'}</div>`;
        } else {
          if (data.caption) {
            const list = splitNumberedList(data.caption);
            saveToHistory(list);
            const favs = getStorage('favorites');
            list.forEach(c => createResultCard(c, favs.includes(c), generationResultsContainer));
          } else {
            generationResultsContainer.innerHTML = `<div class="result-card">${data.error || 'Error'}</div>`;
          }
        }
      })
      .catch(() => {
        setBusy(false);
        generationResultsContainer.innerHTML = '<div class="result-card">Network error.</div>';
      });
    }

    // Calendar
    function populateFavoritesSidebar() {
      favoritesList.innerHTML = '';
      const favorites = getStorage('favorites');
      if (favorites.length === 0) {
        favoritesList.innerHTML = '<p style="font-size:13px;color:var(--text-secondary);">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î³Î±Ï€Î·Î¼Î­Î½Î±.</p>';
        return;
      }
      favorites.forEach(text => {
        const item = document.createElement('div');
        item.className = 'favorite-item';
        item.textContent = text;
        item.draggable = true;
        item.addEventListener('dragstart', e => e.dataTransfer.setData('text/plain', text));
        favoritesList.appendChild(item);
      });
    }

    function renderCalendar() {
      calendarGrid.innerHTML = '';
      ['Î”Î•','Î¤Î¡','Î¤Î•','Î Î•','Î Î‘','Î£Î‘','ÎšÎ¥'].forEach(d => {
        const h = document.createElement('div'); h.className='calendar-day-header'; h.textContent=d; calendarGrid.appendChild(h);
      });
      for (let i=1;i<=31;i++){
        const cell = document.createElement('div'); cell.className='calendar-day'; cell.dataset.day=i;
        const num = document.createElement('div'); num.className='day-number'; num.textContent=i; cell.appendChild(num);
        cell.addEventListener('dragover', e => { e.preventDefault(); cell.classList.add('drag-over'); });
        cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
        cell.addEventListener('drop', e => { e.preventDefault(); cell.classList.remove('drag-over'); scheduleItem(i, e.dataTransfer.getData('text/plain')); });
        calendarGrid.appendChild(cell);
      }
      loadScheduledItems();
    }

    function scheduleItem(day, text) {
      let schedule = JSON.parse(localStorage.getItem('schedule') || '{}');
      if (!schedule[day]) schedule[day] = [];
      if (!schedule[day].includes(text)) schedule[day].push(text);
      localStorage.setItem('schedule', JSON.stringify(schedule));
      loadScheduledItems();
    }

    function loadScheduledItems() {
      const schedule = JSON.parse(localStorage.getItem('schedule') || '{}');
      document.querySelectorAll('.scheduled-item').forEach(i => i.remove());
      for (const day in schedule) {
        const cell = document.querySelector(`.calendar-day[data-day='${day}']`);
        if (!cell) continue;
        schedule[day].forEach(text => {
          const el = document.createElement('div');
          el.className='scheduled-item';
          el.textContent=text;
          cell.appendChild(el);
        });
      }
    }

    // Events
    textTab.addEventListener('click', () => switchTab(textTab, textView));
    imageTab.addEventListener('click', () => switchTab(imageTab, imageView));
    calendarTab.addEventListener('click', () => switchTab(calendarTab, calendarView));
    historyTab.addEventListener('click', () => switchTab(historyTab, historyView));
    settingsTab.addEventListener('click', () => switchTab(settingsTab, settingsView));

    historySubTab.addEventListener('click', () => {
      currentHistoryView = 'history';
      historySubTab.classList.add('active'); favoritesSubTab.classList.remove('active');
      historySubTab.setAttribute('aria-selected','true'); favoritesSubTab.setAttribute('aria-selected','false');
      renderHistory(searchInput.value);
    });
    favoritesSubTab.addEventListener('click', () => {
      currentHistoryView = 'favorites';
      favoritesSubTab.classList.add('active'); historySubTab.classList.remove('active');
      favoritesSubTab.setAttribute('aria-selected','true'); historySubTab.setAttribute('aria-selected','false');
      renderHistory(searchInput.value);
    });

    generateTextBtn.addEventListener('click', () => {
      const topic = document.getElementById('topic-input').value;
      if (!topic) return alert('Î Î±ÏÎ±ÎºÎ±Î»Ï, Î³ÏÎ¬ÏˆÎµ Î­Î½Î± Î¸Î­Î¼Î±!');
      const payload = {
        topic,
        keywords: document.getElementById('keywords').value,
        platform: document.getElementById('platform-select').value,
        contentType: document.getElementById('content-type-select').value,
        tone: document.getElementById('tone-select').value,
        language: document.getElementById('language-select').value,
        model_choice: document.getElementById('model-select').value,
        brand_voice: localStorage.getItem('brandVoice') || ''
      };
      performFetch('/generate-caption', payload, false);
    });

    generateImageBtn.addEventListener('click', () => {
      const prompt = document.getElementById('image-prompt-input').value;
      if (!prompt) return alert('Î Î±ÏÎ±ÎºÎ±Î»Ï, Î´ÏÏƒÎµ Î¼Î¹Î± Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î® Î³Î¹Î± Ï„Î·Î½ ÎµÎ¹ÎºÏŒÎ½Î±!');
      const payload = { prompt, style: document.getElementById('image-style-select').value };
      performFetch('/generate-image', payload, true);
    });

    uploadBtn.addEventListener('click', () => {
      const file = fileInput?.files?.[0];
      if (!file) return alert('Î Î±ÏÎ±ÎºÎ±Î»Ï, ÎµÏ€Î¯Î»ÎµÎ¾Îµ Ï€ÏÏÏ„Î± Î­Î½Î± Î±ÏÏ‡ÎµÎ¯Î¿!');
      const form = new FormData(); form.append('file', file);
      setBusy(true); generationResultsContainer.innerHTML = '';
      fetch('/upload-image', {
        method: 'POST',
        body: form,
        headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
      })
      .then(handleResponseAuth)
      .then(data => {
        if (!data) return;
        setBusy(false);
        if (data.image_url) {
          const card = document.createElement('div'); card.id='image-result-card';
          const img = document.createElement('img'); img.src=data.image_url; img.alt='Uploaded Image';
          const btn = document.createElement('button'); btn.type='button'; btn.className='analyze-btn'; btn.textContent='Î‘Î½Î¬Î»Ï…ÏƒÎ· Î•Î¹ÎºÏŒÎ½Î±Ï‚ Î¼Îµ AI';
          btn.addEventListener('click', () => analyzeImageWithAI(data.image_url));
          card.appendChild(img); card.appendChild(btn);
          generationResultsContainer.appendChild(card);
        } else generationResultsContainer.innerHTML = `<div class="result-card">${data.error || 'Error'}</div>`;
      })
      .catch(() => { setBusy(false); generationResultsContainer.innerHTML='<div class="result-card">Network error.</div>'; });
    });

    function analyzeImageWithAI(url) {
      setBusy(true);
      fetch('/analyze-image', {
        method: 'POST',
        headers: { 'Content-Type':'application/json','Accept':'application/json','X-Requested-With':'XMLHttpRequest' },
        body: JSON.stringify({ image_url: url })
      })
      .then(handleResponseAuth)
      .then(data => {
        if (!data) return; setBusy(false);
        if (data.description) {
          document.getElementById('topic-input').value = data.description;
          textTab.click();
          alert('Î— Î±Î½Î¬Î»Ï…ÏƒÎ· Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ! Î— Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î® Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ ÏƒÏ„Î¿ "ÎšÏÏÎ¹Î¿ Î˜Î­Î¼Î±".');
        } else alert(data.error || 'Î— Î±Î½Î¬Î»Ï…ÏƒÎ· Î±Ï€Î­Ï„Ï…Ï‡Îµ.');
      })
      .catch(() => { setBusy(false); alert('Î£Ï†Î¬Î»Î¼Î± Î´Î¹ÎºÏ„ÏÎ¿Ï… ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Î½Î¬Î»Ï…ÏƒÎ·.'); });
    }

    saveSettingsBtn.addEventListener('click', () => {
      localStorage.setItem('brandVoice', brandVoiceInput.value || '');
      saveSettingsBtn.textContent = 'Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ!';
      setTimeout(() => saveSettingsBtn.textContent = 'Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î¡Ï…Î¸Î¼Î¯ÏƒÎµÏ‰Î½', 2000);
    });

    searchInput.addEventListener('input', e => renderHistory(e.target.value));

    themeSwitch.addEventListener('click', () => {
      const dark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', dark ? 'dark' : 'light');
      themeSwitch.textContent = dark ? 'â˜€ï¸' : 'ğŸŒ™';
      themeSwitch.setAttribute('aria-pressed', dark ? 'true' : 'false');
    });

    // On load
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        themeSwitch.textContent = 'â˜€ï¸';
        themeSwitch.setAttribute('aria-pressed','true');
      }
      brandVoiceInput.value = localStorage.getItem('brandVoice') || '';
      textTab.click(); // ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ· default tab
    });
  </script>
</body>
</html>
